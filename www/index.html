<!DOCTYPE html>
<html>
  <head>
    <title>PhoneGap</title> 
     
    <script src="js/jquery-2.0.3.min.js"></script>   
    <script src="js/presentation.js"></script>
    <script>
        var fs = require("fs");
        var path = require("path");
        global.pg = require("phonegap");  
        global.soundwave = require("phonegap-soundwave");
    
        global.jQuery = jQuery;
        
        global.jQuery(document).ready(function() {
           console.log("ready"); 
           global.projDir = null;
           global.username = null;
           global.password = null;
           global.server = null;
           
           global.soundwave.on("log", function(status, url) { 
               console.log(status, url); 
           });           
           
           global.jQuery("#projectDirectory").change(function() {
               console.log("change handler");
               console.log(global.jQuery("#projectDirectory").val());
               global.projDir = global.jQuery("#projectDirectory").val();
               localStorage.projDir = global.projDir;
               
               enableFormButtons();
               global.jQuery("#currentProjectDir").text("Current project directory: " + global.projDir);
           });
           
           global.jQuery("#createProject").click(function() {
               console.log("create project click handler");
               var option = {};
               option.path = global.projDir;
               global.pg.create(option);
           });
           
           global.jQuery("#openProject").click(function() {
              console.log("open project click handler");
              
              fs.exists(global.projDir + "/www", function(exists) {
                  if (exists) {
                      process.chdir(global.projDir);
                      console.log("project opened at: " + global.projDir);
                  } else {
                      var errMsg = "an existing project doesn't exist in this folder";
                      console.log(errMsg);
                      alert(errMsg);
                  }
              });
           });
           
           global.jQuery("#serveProject").click(function() {
              console.log("serve project click handler");
              
              process.chdir(global.projDir);
 
              global.soundwave.serve({ port: 1337 }, function(e, options) {     
                  if (e) { 
                      console.log("error:", e.message);
                      alert(e.message); 
                  } else { 
                      console.log("server started at address: " + options.address + ":" + options.port); 
                      global.server = options.server;
                      
                      global.jQuery("#stopServer").prop("disabled", false);
                  }
              });         
           });
           
           global.jQuery("#stopServer").click(function() {
              console.log("stop server click handler");             
              global.server.close();
              global.jQuery("#stopServer").prop("disabled", true);           
           });
                    
           global.jQuery("#submit").click(function() {
              console.log("submit click handler");
 
              var username = global.jQuery("#username").val();
              var password = global.jQuery("#password").val();
 
              if (username && password) {
 
                  var options = {}; 
                  options.username = username;
                  options.password = password;

                  global.pg.remote.login(options, function(e) {
                      if (e) {
                          console.log(e.message);
                          alert(e.message);
                      } else {
                          console.log("successful login");

                          global.username = username;
                          global.password = password;

                          global.jQuery("#loginFormHolder").hide();
                          global.jQuery("#loggedInUser").text("Logged in as: " + global.username);
                          global.jQuery("#buildHolder").show();
                      }
                  });
              } else {
                  alert("username or password not entered");
              }      
           });
           
           global.jQuery("#logout").click(function() {
              console.log("logout click handler");
              global.pg.remote.logout({}, function(e) {
                 if (e) {
                     console.log(e.message);
                     alert(e.message); 
                 } else {
                     
                     global.username = null;
                     global.password = null;
                     
                     global.jQuery("#buildHolder").hide();
                     global.jQuery("#loggedInUser").text("");
                     global.jQuery("#loginFormHolder").show();
                 }
              }); 
           });
           
           global.jQuery("#buildProject").click(function() {
              console.log("build project click handler");
              // valid platforms can be found here: https://github.com/phonegap/phonegap-cli/blob/master/doc/cli/help.txt#L29-L35
              var options = {};
              options.platforms = ["ios"];
              
              process.chdir(global.projDir);
              
              global.pg.build(options, function(e) {
                 if (e) {
                     console.log(e.message);
                     alert(e.message);
                 }
              });               
           });
                               
           initGUI();
           
           if (localStorage.projDir != "") {             
               global.projDir = localStorage.projDir;            
               console.log("localStorage.projDir: " + localStorage.projDir);
               enableFormButtons();
               global.jQuery("#currentProjectDir").text("Current project directory: " + global.projDir);
           }
           
        });
        
    </script> 
    <script src="js/index.js"></script> 
     
  </head>
  <body>

      <h1>PhoneGap GUI</h1> 

      <div id="currentProjectDir"></div><br>

      Set project directory <input type="file" id="projectDirectory" nwdirectory><br> 
       
      <input type="button" id="createProject"><br>

      <input type="button" id="openProject"><br>
      
      <input type="button" id="serveProject"><br>
      
      <input type="button" id="stopServer"><br>
      
      <div id="loginFormHolder">
          <form id="loginForm">
              PhoneGap Build Login<br>
              username:<input type="text" id="username"><br>
              password:<input type="password" id="password"><br>
              <input type="button" id="submit">
          </form>
      </div>
      
      <div id="buildHolder">
          <div id="loggedInUser"></div><br>
          <input type="button" id="logout"><br>
          <input type="button" id="buildProject"><br>
      </div>
      
      
      
            
  </body>
</html>     
