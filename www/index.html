<!DOCTYPE html>
<html>
  <head>
    <title>PhoneGap</title> 
    <link rel="stylesheet" type="text/css" href="css/topcoat-mobile-light.min.css"> 
    <link rel="stylesheet" type="text/css" href="css/topcoat-overlay.min.css"> 
    <script src="js/jquery-2.0.3.min.js"></script>   
    <script src="js/presentation.js"></script>
    <script>
        var fs = require("fs");
        var path = require("path"); 
        global.soundwave = require("phonegap-soundwave");
    
        global.jQuery = jQuery;
        
        global.jQuery(document).ready(function() {
           console.log("ready"); 
           global.server = null;
           
           global.soundwave.on("log", function(status, url) { 
               console.log(status, url); 
           });           
           
           global.jQuery("#projectDirectory").change(function() {
               console.log("change handler");
               console.log(global.jQuery("#projectDirectory").val());
               localStorage.projDir = global.jQuery("#projectDirectory").val();
               
               enableFormButtons();
               global.jQuery("#currentProjectDir").text("Current project directory: " + localStorage.projDir);
           });
           
           global.jQuery("#createProject").click(function() {
               console.log("create project click handler");
               var option = {};
               option.path = localStorage.projDir;
               
               // TODO: add soundwave.create api call when it has been implemented
               // global.soundwave.create(options);
               console.log("add soundwave.create api call when it has been implemented");              
               alertOverlay("create functionality not implemented");
               
           });
           
           global.jQuery("#openProject").click(function() {
              console.log("open project click handler");
              global.jQuery("#projectDirectory").trigger("click");
           });
           
           global.jQuery("#alertOk").click(function() {
              hideOverlays();
           });
           
           global.jQuery("#settingsCancel").click(function() {
              console.log("settings cancel click handler");
              hideOverlays();
              global.jQuery("#portNumber").val(localStorage.portNumber);
           });
           
           global.jQuery("#settingsSave").click(function() {
              console.log("settings save click handler");
              var port = global.jQuery("#portNumber").val();
              
              if (global.jQuery.isNumeric(port)) {
                  console.log("port is valid");
                  console.log("port number entered: " + port);
                  localStorage.portNumber = port;
                  hideOverlays();
              } else {
                  console.log("port is invalid");
                  global.jQuery("#settingsMessage").text("port needs to be numeric");
              }
           });
           
           global.jQuery("#settings").click(function() {
              console.log("settings click handler");
              settingsOverlay(); 
           });
           
           global.jQuery("#isServerStarted").click(function() {
              if (global.jQuery("#isServerStarted").is(":checked")) {
                  console.log("server started");
                  
                  fs.exists(localStorage.projDir + "/www", function(exists) {
                      if (exists) {
                          process.chdir(localStorage.projDir);
                          console.log("project opened at: " + localStorage.projDir);                     
                          global.soundwave.serve({ port: localStorage.portNumber }, function(e, options) {     
                              if (e) { 
                                  console.log("error:", e.message);
                                  alertOverlay(e.message); 
                              } else { 
                                  console.log("server started at address: " + options.address + ":" + options.port); 
                                  global.server = options.server;
                              }
                          });
                      } else {
                          var errMsg = "an existing project doesn't exist in this folder";
                          console.log(errMsg);
                          alertOverlay(errMsg);
                          
                          global.jQuery("#isServerStarted").prop("checked", false);
                      }
                  });
                  
              } else {
                  console.log("server stopped");
                  global.server.close();
              }
           });
                                                             
           initGUI();
           
           initSessionData();
           
        });
        
    </script> 
    <script src="js/index.js"></script> 
    <style>
        #settingsMessage { height: 18px }
    </style> 
  </head>
  <body>
      <div id="overlay-bg" class="topcoat-overlay-bg"></div>
      <aside id="alertOverlay" class="topcoat-overlay">
          <div id="alertContent"></div>
          <div class="topcoat-overlay-buttons">
                  <button id="alertOk" class="topcoat-button"></button>
          </div>
      </aside>      
      <aside id="settingsOverlay" class="topcoat-overlay">
          <h3>Settings</h3> 
          <div id="settingsContent">
              <div id="settingsMessage"></div>
              server port: <input type="text" id="portNumber" class="topcoat-text-input">
          </div>
          <div class="topcoat-overlay-buttons">
              <button id="settingsCancel" class="topcoat-button"></button>
              <button id="settingsSave" class="topcoat-button--cta"></button>
          </div>
      </aside>
      
      <h1>PhoneGap GUI</h1>
      
      <div id="currentProjectDir"></div><br>

      <div id="projectDirectoryHolder"><input type="file" id="projectDirectory" nwdirectory></div>
      
      <div class="topcoat-button-bar">
          <div class="topcoat-button-bar__item">
              <button id="createProject" class="topcoat-button-bar__button"></button>
          </div>
          <div class="topcoat-button-bar__item">
              <button id="openProject" class="topcoat-button-bar__button"></button>  
          </div>
          <div class="topcoat-button-bar__item">
              server
              <label class="topcoat-switch">
                  <input type="checkbox" id="isServerStarted" class="topcoat-switch__input">
                  <div class="topcoat-switch__toggle"></div>
              </label>
          </div>          
          <div class="topcoat-button-bar__item">
              <button id="settings" class="topcoat-button-bar__button"></button> 
          </div>
      </div>
                
  </body>
</html>     
